# Сообщения коммитов

Сообщение коммита – невероятно важная вещь, так как зачастую это единственное место,
где можно найти контекст, в котором были произведены изменения кода.

---

## Писать сообщения на английском языке

Если нет уверенности в своих способностях, можно выразиться проще или воспользоваться переводчиком.

### Зачем?
- Чтобы соблюдать правило хорошего тона
- Чтобы не скатываться к перемешиванию непонятных англицизмов с русским языком
- Английский язык — фактически язык любого разработчика. Профессия обязывает его знать.

### Хорошо

```
3cf33864e2 add tests
136e39ff28 add base logic
```

### Плохо

```
3cf33864e2 добавить тесты
136e39ff28 негізгі логиканы қосты
```

---

## Начинать сообщение с заглавной буквы

### Зачем?

- Чтобы текст был читабельнее
- Грамматику никто не отменял. Это мелочь, но внимание к мелочам приближает нас
к совершенству, а не отдаляет от него. Правила стоит нарушать, если от этого есть толк.

### Хорошо

```
0bb3518daf BTB-288: Add basic authorization
```

### Плохо

```
0bb3518daf BTB-288: add basic authorization
```

---

## Использовать глаголы в повелительном наклонении

Повелительное наклонение означает «устное или письменное распоряжение, команда
или инструкция». Например: _add_, _update_, _refactor_ и т.д.

Есть простое правило для написания сообщений в этом стиле:

    Правильно сформированная тема коммита Git должна всегда иметь возможность завершить следующее предложение:

    If applied, this commit will <your message>

### Зачем?

- Сам git использует такой формат, например, когда создает коммиты слияния
- Коммиты можно рассматривать как команды
(например, вид лога и команда revert начинают играть новыми красками)

### Хорошо

```
3cf33864e2 BTB-501: Add integration tests for certificates
af932688a0 BTB-501: Attach certificate logic to the registry import order handler
0bb3518daf BTB-501: Add facade to mark certificate as ready for activation
```

### Плохо

```
3cf33864e2 BTB-501: Integration tests for certificates
af932688a0 BTB-501: Attaching certificate logic
0bb3518daf BTB-501: Added facade to mark certificate as ready for activation
```

---

## Связывать коммит с задачей

Обязательно использовать формат сообщения `<ticket>: <message>`.

Во избежание нарушения этого правила рекомендуется настроить прекоммит-хук,
который проверяет сообщение коммита.

Иногда бывают ситуации, когда нужно закоммитить код без привязки к задаче,
например, хотфикс или выпил флага (хотя, в этих случаях тоже рекомендуется заводить задачи).
Тогда можно использовать заглушку с числом `100500` вместо номера тикета.
Если тикеты привязаны к командам или проектам (в случае `Jira` или `Яндекс.Трекер`),
то следует выбирать очередь своей команды.
Если же это вообще не имеет никакого отношения к продукту,
можно использовать название инжиниринговой очереди (в случае нашей компании `BANG`).

К тому же, GitLab умеют превращать номер задачи в коммите в ссылку на задачу в трекере.

### Зачем?

Ситуация: разработчик приходит исправлять ошибку, находит подозрительное место,
а сообщение коммита, в рамках которого была исправлена строка, выглядит как `add new selector`.
Это, конечно, фиаско, и в этом случае единственная надежда на
хорошее описание задачи в трекере задач, по которому можно будет понять,
почему был написан этот код и какая должна быть логика на самом деле.

Это особенно актуально в нашем случае, когда автоматизация код-ревью
заточена под номер задачи.

_Для пользователей PyCharm_: существует способ настроить встроенную консоль гита
так, чтобы номер тикета сразу оформлялся как ссылка на трекер.

### Хорошо
```
0bb3518daf BTB-100500: Refactor slot__detach interactor
```

### Плохо

```
af932688a0 Add Phone Number Pydantic type, using google's phonenumbers
0bb3518daf NOISSUE-100500: Refactor slot__detach interactor function
```

---

## Сначала надо ответить на вопрос «Зачем?»

В первую очередь при написании сообщения коммита стоит задуматься о том,
зачем вообще был сделан этот коммит? А ответ записать в сообщение.

### Зачем?

По диффам всегда видно, что поменялось.
А вот зачем были внесены изменения, порой решительно непонятно.
Однажды придется исправлять этот код, и можно сэкономить много времени в будущем,
если написать правильное сообщение сейчас.

### Хорошо
```
af932688a0 BTB-501: Attach certificate logic to the registry import order handler
0bb3518daf BTB-501: Add facade to mark certificate as ready for activation
cdb4629fqc BTB-501: Fix bug when phone number saves to database incorrectly
```

### Плохо
```
af932688a0 BTB-501: Add new logic
0bb3518daf BTB-501: Add facade
```

---

## Не стоит смешивать изменения

Это в большей степени относится к культуре создания коммитов,
но сообщения являются отличным маркером.
Если не получается и емко описать, что происходит в этом коммите
(или еще хуже, приходится в теле сообщения написать список изменений),
стоит декомпозировать изменения и закоммитить код
в нескольких последовательных коммитах вместо одного большого.

Иногда лучше сделать 10 маленьких коммитов, чем один большой,
в котором собрано все, что связано с задачей.

**Главное правило**: не коммитить изменения бизнес-логики при написании тестов.
Бывает, что в разных коммитах добавляются модели, потом логика, потом тесты.
Хочется избежать ситуаций, когда в такие коммиты подмешиваются изменения бизнес-логики.
При нахождении бага лучше зафиксировать изменения отдельным коммитом, а потом вернуться к тестам.

Однако, если коммит содержит большой объем кода,
полноценно закрывающий функциональность (т.е. это вся бизнес-логика и тесты, например),
допустимо закоммитить все вместе.
Но тут срабатывает правило «попробуй кратко и емко описать, что происходит в этом коммите».

Если кратко описать не получается, вместо того, чтобы писать общее сообщение,
стоит подумать, что в этом коммите самое важное?
После этого подумать, допустимо ли смешивать изменения.
Иногда ответ может быть положительный, иногда отрицательный.

### Зачем?

Чтобы иметь возможность кратко и емко описать, зачем нужен этот коммит.
К тому же, следовать многим другим рекомендациям невозможно без выполнения этого условия.

## Хорошо
```

# закоммитили разные учатки кода в разных коммитах

3cf33864e2 BTB-288: Fix program annotation
    programs/facades.py

af932688a0 BTB-288: Add certificate activation via Tilda
  certificates/facades.py

0bb3518daf BTB-288: Add unit tests for certificate activation
  certificates/tests/test_facades.py
```

или

```
# закоммитили всю фичу целиком

3cf33864e2 BTB-288: Add certificates activation via Tilda

  programs/facades.py
  certificates/facades.py
  certificates/tests/test_facades.py
```

### Плохо

```
# непонятное сообщение, при этом затронуто очень много приложений

3cf33864e2 BTB-288: Add logic

  appeals/facades.py
  programs/facades.py
  certificates/facades.py
  certificates/tests/test_facades.py
  settings.py
```

или

```
# в сообщении про тесты, но среди файлов бизнес-логика

3cf33864e2 BTB-288: Add integration tests

  certificates/facades.py
  certificates/tests/test_facades.py
```

---

## Писать осмысленные сообщения

Иногда хочется написать «исправил баг» или «исправления после код-ревью».
Лучше не поддаваться этому желанию, а постараться максимально четко и ясно написать,
что и зачем было сделано.

### Зачем?

Все затем же. Чтобы однажды иметь возможность понять, зачем было сделано то или иное изменение.
К тому же, такой подход заставит задуматься, а надо ли все исправления по код-ревью пихать в один коммит.
Может, не стоит?

### Хорошо

```
3cf33864e2 BTB-501: Fix typo in error message
af932688a0 BTB-501: Fix duplication of requests in annotation
0bb3518daf BTB-501: Add logic for manual certificate activation
```

**Плохо**

```
3cf33864e2 BTB-501: CR fixes
af932688a0 BTB-501: Fix error
0bb3518daf BTB-501: Add logic
```

---

## Сообщения должны занимать одну строку

Не надо писать длинные сообщения на много строк.
Не надо пытаться описать в сообщении всю бизнес-логику или скопировать текст связанной задачи в трекере.

**Важно!** В некоторых случаях допустимо написать в теле большое сообщение,
в котором можно подробно описать проблему и способ её решения, но это бывает редко.
Для полноты контекста обычно достаточно ссылки на тикет и короткого сообщения.

## Зачем?

- (Конкретно в нашем случае) автоматизация код-ревью не заточена под многострочные коммиты
- GitLab не очень хорошо отображает многострочные коммиты и сворачивает их по умолчанию
- Если хочется написать многострочное сообщение, стоит задуматься,
соответствует ли коммит описанным выше рекомендациям.

### Хорошо

```
3cf33864e2 BTB-288: Fix program annotation
```

### Плохо

```
3cf33864e2 BTB-288: Fix programs
  - fix selectors
  - fix templates
  - fix facades
```

---

## Не забывать про amend во время локальной разработки

Опция `--amend` позволяет закоммитить изменения в рамках предыдущего коммита,
с возможностью переопределить сообщение.

**Важно!**
Как только код в общедоступном репозитории, использовать эту опцию нельзя;
`--amend` работает только локально, на коммитах, которые не запушены.
Нарушение этой рекомендации может привести к рассинхронизации ветвей репозитория.

### Зачем?

Чтобы не генерировать мусорные коммиты.

### Хорошо
```
3cf33864e2 BTB-501: Add logic for manual certificate activation

  certificates/facades.py
  certificates/selectors.py
  certificates/interactors.py
```
### Плохо
```
3cf33864e2 BTB-501: Add logic for manual certificate activation
  certificates/facades.py

af932688a0 BTB-501: Add logic for manual certificate activation
  certificates/selectors.py
  certificates/interactors.py
```

---

## Не ставить точку в конце строки

### Зачем?

А зачем ставить? 🙃

### Хорошо
```
3cf33864e2 BTB-288: Fix program annotation
```
### Плохо
```
3cf33864e2 BTB-288: Fix program annotation.
```

---

Полезные статьи:
- [Как писать сообщения коммитов в Git [Medium]](https://medium.com/grisme/как-писать-сообщения-коммитов-в-git-9ed19ebc5ebf) + [оригинал](https://cbea.ms/git-commit/)
- [Как оформлять коммиты, чтобы потом не было больно [Хабр]](https://habr.com/ru/companies/Voximplant/articles/276695/)
